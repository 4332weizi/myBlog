## 概述

本文为 WebSocket 协议的第六章，本文翻译的主要内容为 WebSocket 消息发送与接收相关内容。

有兴趣了解该文档之前几章内容的同学可以见：

- [【译】WebSocket 协议——摘要（ Abstract ）][1]
- [【译】WebSocket 协议第一章——介绍（ Introduction ）][2]
- [【译】WebSocket 协议第二章——一致性要求（ Conformance Requirements ）][3]
- [【译】WebSocket 协议第三章——WebSocket网址（ WebSocket URIs ）][4]
- [【译】WebSocket 协议第四章——连接握手（ Opening Handshake ）][5]
- [【译】WebSocket 协议第五章——数据帧（Data Framing）][6]

## 发送与接收消息（协议正文）

### 6.1 发送数据

为了通过 WebSocket 连接`发送一条 WebSocket 消息`，终端必须遵循以下几个步骤：

1. 终端必须保证 WebSocket 连接处于 OPEN 状态（见第 4.1 节和第 4.2.2 节）。如果 WebSocket 连接的任意一点的状态发生了改变，终端必须中止以下步骤。
2. 终端必须将数据按照第 5.2 节定义的 WebSocket 帧进行封装。如果需要发送的数据过大或者在终端希望开始发消息时，如果数据在整体性这一点上不可用，那么终端可能会选择通过在第 5.4 节中定义的一系列帧来进行封装。
3. 包含数据的第一帧操作码（帧操作码）必须根据第 5.2 节中的内容设置的合适的值，以便接收者将数据解析为文本或者二进制数据。
4. 最后一个包含数据的帧的 FIN （ FIN 帧）字段必须和第 5.2 节中定义的一样设置为 1 。
5. 如果数据被发送到了客户端，数据帧必须和第 5.3 节中定义的一样添加掩码。
6. 如果在 WebsSocket 连接中有协商扩展（第 9 章），在这些扩展中的定义和注意事项也许要额外考虑。
7. 被格式化的帧必须通过底层的网络连接进行传输。

### 6.2 接收数据

为了接收 WebSocket 数据，终端需要监听底层网络连接。输入的数据必须通过第 5.2 节定义的 WebSocket 帧进行解析。如果收到了一个控制帧（第 5.5 节），那么这个帧必须如 5.5 节中定义的方式进行处理。如果收到的是一个数据帧，那么终端必须注意 5.2 节中的定义在操作码（帧操作码）中的数据类型。在这一帧中的“应用数据”被定义为消息的数据。如果帧中包含未分片的数据（第 5.4 节），那么就认为：一条 WebSocket 消息的数据和类型被收到了。如果帧是分片数据的一部分，那么随后的帧包含的“应用数据”连起来就是数据的格式。当通过 FIN 字段（FIN帧）表示的最后一个片段被收到时，我们可以说：一条 WebSocket 消息的数据（由片段组装起来的“应用数据”数据组成）和类型（注意分片消息的第一帧）已经被收到了。接下来的数据帧必须是属于一条新的 WebSocket 消息。

扩展（第 9 章）可能改变数据如何理解的方式，具体包括消息的内容边界。扩展，除了在“应用数据”之前添加“扩展数据”之外，也可以修改“应用数据”（例如压缩它）。

像第 5.3 节中说的那样，服务端在收到客户端的数据帧时必须去除掩码。

[1]:	https://juejin.im/post/5b12966fe51d450689495e41
[2]:	https://juejin.im/post/5b1a7189e51d45068b496cf0
[3]:	https://juejin.im/post/5b1e6beae51d4506b62cbd64
[4]:	https://juejin.im/post/5b226d716fb9a00e594c5da5
[5]:	https://juejin.im/post/5b2b9850518825748e545d23
[6]:	https://juejin.im/post/5c32f906f265da6136229fac